<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Generator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .profile-option {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .profile-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .profile-option input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .profile-option label {
            cursor: pointer;
            font-weight: 500;
            font-size: 1.1em;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .form-group input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .fields-section {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border-radius: 6px;
        }

        .field-group {
            margin-bottom: 20px;
        }

        .field-group h3 {
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .field-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .field-option {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .field-option input[type="checkbox"] {
            margin-right: 8px;
        }

        .field-option label {
            cursor: pointer;
            font-size: 0.95em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .output-section {
            margin-top: 30px;
        }

        .output-area {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #f8f9fa;
            resize: vertical;
        }

        .download-btn {
            margin-top: 15px;
            background: #28a745;
            color: white;
        }

        .download-btn:hover {
            background: #218838;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box p {
            margin: 5px 0;
            color: #0c5460;
        }

        .checkbox-all {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .checkbox-all input {
            margin-right: 10px;
        }

        .checkbox-all label {
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Track Generator</h1>
            <p>Convert track profiles to XML scenario files</p>
        </div>

        <div class="content">
            <div class="info-box">
                <p><strong>Instructions:</strong></p>
                <p>1. Select one or more track profiles below</p>
                <p>2. Configure the number of tracks and starting position</p>
                <p>3. Optionally uncheck "Include All Fields" to customize which optional fields to include</p>
                <p>4. Click "Generate XML" to create your scenario file</p>
                <p><strong>Note:</strong> Latitude and Longitude are always required for all profiles.</p>
            </div>

            <div class="section">
                <h2>1. Select Track Profiles</h2>
                <div class="profile-grid">
                    <div class="profile-option" onclick="toggleProfile(this, 'TOAD_J-Series_Reference_Point')">
                        <input type="checkbox" id="profile_reference" value="TOAD_J-Series_Reference_Point">
                        <label for="profile_reference">Reference Point</label>
                    </div>
                    <div class="profile-option" onclick="toggleProfile(this, 'TOAD_J-Series_Air')">
                        <input type="checkbox" id="profile_air" value="TOAD_J-Series_Air">
                        <label for="profile_air">Air</label>
                    </div>
                    <div class="profile-option" onclick="toggleProfile(this, 'TOAD_J-Series_Land')">
                        <input type="checkbox" id="profile_land" value="TOAD_J-Series_Land">
                        <label for="profile_land">Land</label>
                    </div>
                    <div class="profile-option" onclick="toggleProfile(this, 'TOAD_J-Series_Surface')">
                        <input type="checkbox" id="profile_surface" value="TOAD_J-Series_Surface">
                        <label for="profile_surface">Surface</label>
                    </div>
                    <div class="profile-option" onclick="toggleProfile(this, 'TOAD_J-Series_SubSurface')">
                        <input type="checkbox" id="profile_subsurface" value="TOAD_J-Series_SubSurface">
                        <label for="profile_subsurface">Subsurface</label>
                    </div>
                    <div class="profile-option" onclick="toggleProfile(this, 'TOAD_J-Series_Space')">
                        <input type="checkbox" id="profile_space" value="TOAD_J-Series_Space">
                        <label for="profile_space">Space</label>
                    </div>
                    <div class="profile-option" onclick="toggleProfile(this, 'TOAD_J-Series_EW')">
                        <input type="checkbox" id="profile_ew" value="TOAD_J-Series_EW">
                        <label for="profile_ew">EW</label>
                    </div>
                    <div class="profile-option" onclick="toggleAll(this)">
                        <input type="checkbox" id="profile_all" value="ALL">
                        <label for="profile_all">All Profiles</label>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>2. Configuration</h2>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="num_tracks">Number of Tracks:</label>
                        <input type="number" id="num_tracks" value="100" min="1" max="10000">
                    </div>
                    <div class="form-group">
                        <label for="start_lat">Starting Latitude:</label>
                        <input type="number" id="start_lat" value="33.0" step="0.001">
                    </div>
                    <div class="form-group">
                        <label for="start_long">Starting Longitude:</label>
                        <input type="number" id="start_long" value="-117.0" step="0.001">
                    </div>
                    <div class="form-group">
                        <label for="delay">Delay Between Tracks (seconds):</label>
                        <input type="number" id="delay" value="1" min="0" max="60">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>3. Optional Field Selection</h2>
                <div class="checkbox-all">
                    <input type="checkbox" id="select_all_fields" checked onchange="toggleAllFields(this)">
                    <label for="select_all_fields">Include All Optional Fields (Recommended)</label>
                </div>
                <div id="fields-container" class="fields-section" style="display: none;">
                    <!-- Optional fields will be dynamically populated here based on selected profiles -->
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="generateXML()">Generate XML</button>
                <button class="btn btn-secondary" onclick="resetForm()">Reset</button>
            </div>

            <div id="output-section" class="output-section" style="display: none;">
                <div class="section">
                    <h2>Generated XML</h2>
                    <textarea id="output" class="output-area" readonly></textarea>
                    <button class="btn download-btn" onclick="downloadXML()">Download XML File</button>
                </div>
            </div>
        </div>
    </div>

    <script src="extracted_arrays.js" type="module"></script>
    <script type="module">
        // Import the data arrays
        import * as DATA from './extracted_arrays.js';

        // Make DATA available globally
        window.TRACK_DATA = DATA;

        // Track selected profiles
        let selectedProfiles = [];
        let includeAllFields = true;

        // Optional fields for each profile type
        // Latitude and Longitude are ALWAYS required and not shown as optional
        // Any field not listed here will be automatically included
        const OPTIONAL_FIELDS = {
            'TOAD_J-Series_Air': [
                'Callsign Published',
                'True Course',
                'Speed',
                'Altitude',
                'Platform',
                'Activity',
                'Specific Type',
                'Strength',
                'Local TQ',
                'SPI',
                'Identity',
                'Hour',
                'Minute',
                'Mode 1 Code',
                'Mode 2 Code',
                'Mode 3 Code',
                'Mode 4 Indicator',
                'Mode 5 Indicator',
                'Mode 5 Nationality'
            ],
            'TOAD_J-Series_Land': [
                'True Course',
                'Speed',
                'Elevation',
                'Point/Track Ind',
                'Platform',
                'Activity',
                'Specific Type',
                'Strength',
                'Local TQ',
                'SPI',
                'Identity',
                'Hour',
                'Minute',
                'Mode 1 Code',
                'Mode 2 Code',
                'Mode 3 Code',
                'Mode 4 Indicator',
                'Mode 5 Indicator',
                'Mode 5 Nationality'
            ],
            'TOAD_J-Series_SubSurface': [
                'True Course',
                'Speed',
                'Depth',
                'Platform',
                'Activity',
                'Specific Type',
                'Local TQ',
                'SPI',
                'Identity',
                'Hour',
                'Minute',
                'Mode 1 Code',
                'Mode 2 Code',
                'Mode 3 Code',
                'Mode 4 Indicator',
                'Mode 5 Indicator',
                'Mode 5 Nationality',
                'Subsurface Sensor',
                'Confidence Level',
                'Depth Contact'
            ],
            'TOAD_J-Series_Space': [
                'True Course',
                'Speed',
                'Altitude',
                'Platform',
                'Activity',
                'Specific Type',
                'Local TQ',
                'SPI',
                'Identity',
                'Minute',
                'Seconds',
                'Boost Ind',
                'Lost Track Indicator',
                'Space Amplification',
                'Space Amplification Ambiguity 1'
            ],
            'TOAD_J-Series_Surface': [
                'True Course',
                'Speed',
                'Platform',
                'Activity',
                'Specific Type',
                'Strength',
                'Local TQ',
                'SPI',
                'Identity',
                'Hour',
                'Minute',
                'Mode 1 Code',
                'Mode 3 Code',
                'Mode 2 Code',
                'Mode 4 Indicator',
                'Mode 5 Indicator',
                'Mode 5 Nationality'
            ],
            'TOAD_J-Series_EW': [
                'True Course',
                'Speed',
                'Altitude',
                'Environ/Category',
                'Platform',
                'Activity',
                'Track 3.7/14.0 Indicator',
                'Specific Type',
                'SPI',
                'Identity'
            ],
            'TOAD_J-Series_Reference_Point': [
                'True Course',
                'Speed',
                'Altitude',
                'Amplification',
                'SPI'
            ]
        };

        window.toggleProfile = function(element, profile) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                element.classList.add('selected');
                if (!selectedProfiles.includes(profile)) {
                    selectedProfiles.push(profile);
                }
            } else {
                element.classList.remove('selected');
                selectedProfiles = selectedProfiles.filter(p => p !== profile);
                // Uncheck "All" if any profile is unchecked
                document.getElementById('profile_all').checked = false;
                document.querySelector('.profile-option:last-child').classList.remove('selected');
            }

            updateFieldsDisplay();
        };

        window.toggleAll = function(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;

            const allProfiles = [
                'TOAD_J-Series_Reference_Point',
                'TOAD_J-Series_Air',
                'TOAD_J-Series_Land',
                'TOAD_J-Series_Surface',
                'TOAD_J-Series_SubSurface',
                'TOAD_J-Series_Space',
                'TOAD_J-Series_EW'
            ];

            if (checkbox.checked) {
                element.classList.add('selected');
                selectedProfiles = [...allProfiles];
                // Check all individual profile checkboxes
                document.querySelectorAll('.profile-option input[type="checkbox"]').forEach(cb => {
                    cb.checked = true;
                    cb.parentElement.classList.add('selected');
                });
            } else {
                element.classList.remove('selected');
                selectedProfiles = [];
                // Uncheck all individual profile checkboxes
                document.querySelectorAll('.profile-option input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                    cb.parentElement.classList.remove('selected');
                });
            }

            updateFieldsDisplay();
        };

        window.toggleAllFields = function(checkbox) {
            includeAllFields = checkbox.checked;
            const fieldsContainer = document.getElementById('fields-container');
            fieldsContainer.style.display = checkbox.checked ? 'none' : 'block';

            if (!checkbox.checked) {
                updateFieldsDisplay();
            }
        };

        function updateFieldsDisplay() {
            if (includeAllFields) return;

            const fieldsContainer = document.getElementById('fields-container');
            if (selectedProfiles.length === 0) {
                fieldsContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: #6c757d;">Please select at least one profile to see available fields.</p>';
                return;
            }

            // Get unique optional fields from all selected profiles
            const allOptionalFields = new Set();
            selectedProfiles.forEach(profile => {
                if (OPTIONAL_FIELDS[profile]) {
                    OPTIONAL_FIELDS[profile].forEach(field => allOptionalFields.add(field));
                }
            });

            // Sort fields alphabetically
            const sortedFields = Array.from(allOptionalFields).sort();

            // Display info about required fields
            let html = `<div style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                <p style="margin: 0; color: #0c5460;"><strong>Note:</strong> Latitude and Longitude are always required and included.
                Fields not listed below will be automatically included. Uncheck any optional field to exclude it.</p>
            </div>`;

            html += `<div class="field-group">
                <h3>Optional Fields</h3>
                <div class="field-options">`;

            sortedFields.forEach(field => {
                const fieldId = `field_${field.replace(/[^a-zA-Z0-9]/g, '_')}`;
                html += `<div class="field-option">
                    <input type="checkbox" id="${fieldId}" value="${field}" checked>
                    <label for="${fieldId}">${field}</label>
                </div>`;
            });

            html += `</div></div>`;

            fieldsContainer.innerHTML = html;
        }

        window.generateXML = function() {
            if (selectedProfiles.length === 0) {
                alert('Please select at least one track profile.');
                return;
            }

            const numTracks = parseInt(document.getElementById('num_tracks').value);
            const startLat = parseFloat(document.getElementById('start_lat').value);
            const startLong = parseFloat(document.getElementById('start_long').value);
            const delay = parseInt(document.getElementById('delay').value);

            // Get selected fields if not including all
            let selectedFields = null;
            if (!includeAllFields) {
                selectedFields = Array.from(document.querySelectorAll('#fields-container input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
            }

            // Generate tracks
            const tracks = generateTracks(numTracks, startLat, startLong, delay, selectedProfiles, selectedFields);

            // Create XML
            const xml = createXML(tracks);

            // Display output
            document.getElementById('output').value = xml;
            document.getElementById('output-section').style.display = 'block';
            document.getElementById('output-section').scrollIntoView({ behavior: 'smooth' });
        };

        function generateTracks(numTracks, startLat, startLong, delay, profiles, selectedFields) {
            const tracks = [];
            let latOffset = 0;
            let longOffset = 0;
            const lineLength = 1000;

            for (let i = 0; i < numTracks; i++) {
                const lat = startLat + latOffset;
                const lon = startLong + longOffset;

                longOffset += 0.02;
                if (i % lineLength === 0 && i !== 0) {
                    longOffset = 0.1;
                    latOffset += 0.1;
                }

                // Select random profile from selected profiles
                const profile = profiles[Math.floor(Math.random() * profiles.length)];

                // Generate track
                const track = generateSingleTrack(i, profile, lat, lon, selectedFields);
                tracks.push({ track, delay });
            }

            return tracks;
        }

        // Helper function to check if a field should be included
        function shouldIncludeField(fieldName, profile, selectedFields) {
            // Latitude and Longitude are ALWAYS required
            if (fieldName === 'Latitude' || fieldName === 'Longitude') {
                return true;
            }

            // If including all fields, include everything
            if (selectedFields === null) {
                return true;
            }

            // Check if this field is in the optional fields list for this profile
            const optionalFields = OPTIONAL_FIELDS[profile] || [];
            const isOptional = optionalFields.includes(fieldName);

            if (isOptional) {
                // This is an optional field - only include if user selected it
                return selectedFields.includes(fieldName);
            } else {
                // This is a required/automatic field - always include it
                return true;
            }
        }

        function generateSingleTrack(index, profile, lat, lon, selectedFields) {
            const trackNumber = (512 + index).toString(8);
            const track = {
                name: trackNumber,
                profile: profile,
                fields: {}
            };

            // Required fields - always included
            track.fields['Latitude'] = lat.toFixed(6);
            track.fields['Longitude'] = lon.toFixed(6);
            track.fields['Track Label'] = trackNumber;

            // Profile-specific fields
            if (profile === 'TOAD_J-Series_Air') {
                track.fields['Callsign Published'] = randomChoice(TRACK_DATA.callsign_list);
                track.fields['True Course'] = randomInt(0, 359);
                track.fields['Speed'] = randomInt(0, 300);
                track.fields['Altitude'] = randomInt(0, 204750);
                track.fields['Platform'] = randomChoice(TRACK_DATA.air_platform);
                track.fields['Activity'] = randomChoice(TRACK_DATA.air_activity_type);
                track.fields['Specific Type'] = randomChoice(TRACK_DATA.air_specific_type);
                track.fields['Hour'] = randomInt(0, 23);
                track.fields['Minute'] = randomInt(0, 59);
                track.fields['Strength'] = randomChoice(TRACK_DATA.strength);
                track.fields['SPI'] = randomChoice(TRACK_DATA.spitype);
                track.fields['Identity'] = randomChoice(TRACK_DATA.track_identity);
                track.fields['Mode 1 Code'] = randomChoice(TRACK_DATA.mode_1_options);
                track.fields['Mode 2 Code'] = randomInt(0, 4095).toString(8);
                track.fields['Mode 3 Code'] = randomChoice(TRACK_DATA.mode_3_options);
                track.fields['Mode 4 Indicator'] = randomChoice(TRACK_DATA.mode_4_indicator);
                track.fields['Mode 5 Indicator'] = randomChoice(TRACK_DATA.mode_5_indicator);
                track.fields['Mode 5 Nationality'] = randomChoice(TRACK_DATA.mode_5_nationality);
                track.fields['Mode 5 Platform ID'] = randomInt(0, 16383).toString(8);
                track.fields['Mode 1 Enhanced'] = randomInt(0, 4095).toString(8);
                track.fields['Mode S Aircraft Address'] = randomInt(0, 16777214);
            } else if (profile === 'TOAD_J-Series_Land') {
                const landType = randomChoice(TRACK_DATA.tracktype35);
                track.fields['Point/Track Ind'] = landType;
                if (landType !== 'POINT') {
                    track.fields['True Course'] = randomInt(0, 359);
                    track.fields['Speed'] = randomInt(0, 300);
                }
                track.fields['Elevation'] = randomInt(0, 51150);
                track.fields['Platform'] = randomChoice(TRACK_DATA.land_platform);
                track.fields['Activity'] = randomChoice(TRACK_DATA.land_activity_type);
                track.fields['Specific Type'] = randomChoice(TRACK_DATA.land_specific_type);
                track.fields['Hour'] = randomInt(0, 23);
                track.fields['Minute'] = randomInt(0, 59);
                track.fields['Strength'] = randomChoice(TRACK_DATA.strength);
                track.fields['SPI'] = randomChoice(TRACK_DATA.spitype);
                track.fields['Identity'] = randomChoice(TRACK_DATA.track_identity);
                track.fields['Mode 1 Code'] = randomChoice(TRACK_DATA.mode_1_options);
                track.fields['Mode 2 Code'] = randomInt(0, 4095).toString(8);
                track.fields['Mode 3 Code'] = randomChoice(TRACK_DATA.mode_3_options);
                track.fields['Mode 4 Indicator'] = randomChoice(TRACK_DATA.mode_4_indicator);
                track.fields['Mode 5 Indicator'] = randomChoice(TRACK_DATA.mode_5_indicator);
                track.fields['Mode 5 Nationality'] = randomChoice(TRACK_DATA.mode_5_nationality);
                track.fields['Mode 5 Platform ID'] = randomInt(0, 16383).toString(8);
                track.fields['Mode 1 Enhanced'] = randomInt(0, 4095).toString(8);
            } else if (profile === 'TOAD_J-Series_Surface') {
                track.fields['True Course'] = randomInt(0, 359);
                track.fields['Speed'] = randomInt(0, 300);
                track.fields['Platform'] = randomChoice(TRACK_DATA.surface_platform);
                track.fields['Activity'] = randomChoice(TRACK_DATA.surface_activity_type);
                track.fields['Specific Type'] = randomChoice(TRACK_DATA.surface_specific_type);
                track.fields['Hour'] = randomInt(0, 23);
                track.fields['Minute'] = randomInt(0, 59);
                track.fields['Strength'] = randomChoice(TRACK_DATA.strength);
                track.fields['SPI'] = randomChoice(TRACK_DATA.spitype);
                track.fields['Identity'] = randomChoice(TRACK_DATA.track_identity);
                track.fields['Mode 1 Code'] = randomChoice(TRACK_DATA.mode_1_options);
                track.fields['Mode 2 Code'] = randomInt(0, 4095).toString(8);
                track.fields['Mode 3 Code'] = randomChoice(TRACK_DATA.mode_3_options);
                track.fields['Mode 4 Indicator'] = randomChoice(TRACK_DATA.mode_4_indicator);
                track.fields['Mode 5 Indicator'] = randomChoice(TRACK_DATA.mode_5_indicator);
                track.fields['Mode 5 Nationality'] = randomChoice(TRACK_DATA.mode_5_nationality);
                track.fields['Mode 5 Platform ID'] = randomInt(0, 16383).toString(8);
                track.fields['Mode 1 Enhanced'] = randomInt(0, 4095).toString(8);
            } else if (profile === 'TOAD_J-Series_SubSurface') {
                const trackInd = randomChoice(TRACK_DATA.track_ind_name);
                track.fields['Track 3.4/5.4 Indicator'] = trackInd;

                if (trackInd === 'J3.4 Track(ASW)') {
                    track.fields['Depth'] = randomInt(0, 6200);
                }
                track.fields['True Course'] = randomInt(0, 359);
                track.fields['Speed'] = randomInt(0, 300);
                track.fields['Platform'] = randomChoice(TRACK_DATA.subsurface_platform);
                track.fields['Activity'] = randomChoice(TRACK_DATA.subsurface_activity_type);
                track.fields['Specific Type'] = randomChoice(TRACK_DATA.subsurface_specific_type);
                track.fields['Hour'] = randomInt(0, 23);
                track.fields['Minute'] = randomInt(0, 59);
                track.fields['SPI'] = randomChoice(TRACK_DATA.spitype);
                track.fields['Identity'] = randomChoice(TRACK_DATA.track_identity);
                track.fields['Mode 1 Code'] = randomChoice(TRACK_DATA.mode_1_options);
                track.fields['Mode 2 Code'] = randomInt(0, 4095).toString(8);
                track.fields['Mode 3 Code'] = randomChoice(TRACK_DATA.mode_3_options);
                track.fields['Mode 4 Indicator'] = randomChoice(TRACK_DATA.mode_4_indicator);
                track.fields['Mode 5 Indicator'] = randomChoice(TRACK_DATA.mode_5_indicator);
                track.fields['Mode 5 Nationality'] = randomChoice(TRACK_DATA.mode_5_nationality);
                track.fields['Mode 5 Platform ID'] = randomInt(0, 16383).toString(8);
                track.fields['Mode 1 Enhanced'] = randomInt(0, 4095).toString(8);
                track.fields['Subsurface Sensor'] = randomChoice(TRACK_DATA.subsurface_sensor_list);
                track.fields['Confidence Level'] = randomChoice(TRACK_DATA.confidence_level_list);
                track.fields['Depth Contact'] = randomChoice(TRACK_DATA.depth_contact_list);

                if (trackInd === 'J5.4 Track(ASW Acoustic Bearing/Range)') {
                    track.fields['Bearing 1'] = randomInt(0, 359);
                    track.fields['Bearing Origin'] = 'Latitude/Longitude';
                    track.fields['Audio'] = randomChoice(TRACK_DATA.audio_list);
                    track.fields['Sensor Depth'] = randomChoice(TRACK_DATA.sensor_depth_list);
                    track.fields['Broadband Noise'] = randomChoice(TRACK_DATA.broadband_noise_list);
                    track.fields['Doppler'] = randomChoice(TRACK_DATA.doppler_type_list);
                    track.fields['Sound Propagation Path'] = randomChoice(TRACK_DATA.sound_prop_list);
                }
            } else if (profile === 'TOAD_J-Series_Space') {
                track.fields['Altitude'] = randomInt(0, 204750);
                track.fields['True Course'] = randomInt(0, 359);
                track.fields['Speed'] = randomInt(0, 300);
                track.fields['Platform'] = randomChoice(TRACK_DATA.space_platform);
                track.fields['Activity'] = randomChoice(TRACK_DATA.space_activity_type);
                track.fields['Specific Type'] = randomChoice(TRACK_DATA.space_specific_type);
                track.fields['Space Amplification'] = randomChoice(TRACK_DATA.space_amp);
                track.fields['Space Amplification Ambiguity 1'] = randomChoice(TRACK_DATA.space_amp);
                track.fields['Minute'] = randomInt(0, 59);
                track.fields['Seconds'] = randomInt(0, 59);
                track.fields['Boost Ind'] = randomChoice(TRACK_DATA.space_boost_indicator);
                track.fields['Lost Track Indicator'] = randomChoice(TRACK_DATA.space_lost);
                track.fields['SPI'] = randomChoice(TRACK_DATA.spitype);
                track.fields['Identity'] = randomChoice(TRACK_DATA.track_identity);
            } else if (profile === 'TOAD_J-Series_EW') {
                const trackInd = randomChoice(TRACK_DATA.ew_ind_name);
                track.fields['Track 3.7/14.0 Indicator'] = trackInd;
                track.fields['Track Type'] = 'EW';

                const envCat = randomChoice(TRACK_DATA.ew_environment);
                track.fields['Environ/Category'] = envCat;

                track.fields['Altitude'] = randomInt(0, 204750);
                track.fields['True Course'] = randomInt(0, 359);
                track.fields['Speed'] = randomInt(0, 300);

                if (envCat === 'Air') {
                    track.fields['Platform'] = randomChoice(TRACK_DATA.air_platform);
                    track.fields['Activity'] = randomChoice(TRACK_DATA.air_activity_type);
                    track.fields['Specific Type'] = randomChoice(TRACK_DATA.air_specific_type);
                } else if (envCat === 'Land') {
                    track.fields['Platform'] = randomChoice(TRACK_DATA.land_platform);
                    track.fields['Activity'] = randomChoice(TRACK_DATA.land_activity_type);
                    track.fields['Specific Type'] = randomChoice(TRACK_DATA.land_specific_type);
                } else if (envCat === 'Surface') {
                    track.fields['Platform'] = randomChoice(TRACK_DATA.surface_platform);
                    track.fields['Activity'] = randomChoice(TRACK_DATA.surface_activity_type);
                    track.fields['Specific Type'] = randomChoice(TRACK_DATA.surface_specific_type);
                } else if (envCat === 'Subsurface') {
                    track.fields['Platform'] = randomChoice(TRACK_DATA.subsurface_platform);
                    track.fields['Activity'] = randomChoice(TRACK_DATA.subsurface_activity_type);
                    track.fields['Specific Type'] = randomChoice(TRACK_DATA.subsurface_specific_type);
                } else if (envCat === 'Space') {
                    track.fields['Platform'] = randomChoice(TRACK_DATA.space_platform);
                    track.fields['Activity'] = randomChoice(TRACK_DATA.space_activity_type);
                    track.fields['Specific Type'] = randomChoice(TRACK_DATA.space_specific_type);
                }

                if (trackInd !== 'J14.0 Track(EW Parametrics)') {
                    track.fields['SPI'] = randomChoice(TRACK_DATA.spitype);
                    track.fields['Identity'] = randomChoice(TRACK_DATA.track_identity);
                }
            } else if (profile === 'TOAD_J-Series_Reference_Point') {
                track.fields['Altitude'] = randomInt(0, 51150);
                track.fields['Point Type'] = randomChoice(TRACK_DATA.reference_track_point_name);

                const pointType = track.fields['Point Type'];
                if (pointType === 'Emergency') {
                    track.fields['Amplification'] = randomChoice(TRACK_DATA.emergency_amp);
                } else if (pointType === 'Hazard') {
                    track.fields['Amplification'] = randomChoice(TRACK_DATA.hazard_amp);
                } else if (pointType === 'Reference Point (General)') {
                    track.fields['Amplification'] = randomChoice(TRACK_DATA.reference_amp);
                } else if (pointType === 'Station (General)') {
                    track.fields['Amplification'] = randomChoice(TRACK_DATA.general_station_amp);
                } else if (pointType === 'Station (Air)') {
                    track.fields['Amplification'] = randomChoice(TRACK_DATA.air_station_amp);
                } else if (pointType === 'Area (General)') {
                    track.fields['Amplification'] = randomChoice(TRACK_DATA.general_area_amp);
                } else if (pointType === 'Area (Hazard)') {
                    track.fields['Amplification'] = randomChoice(TRACK_DATA.hazard_area_amp);
                } else if (pointType === 'ASW') {
                    track.fields['Amplification'] = randomChoice(TRACK_DATA.asw_amp);
                    track.fields['Time Function'] = 'TIME POINT ESTABLISHED';
                } else if (pointType === 'ASW, 1') {
                    track.fields['Amplification'] = randomChoice(TRACK_DATA.asw1_amp);
                }
            }

            // Filter fields based on user selection
            if (selectedFields !== null) {
                const filteredFields = {};
                Object.entries(track.fields).forEach(([fieldName, fieldValue]) => {
                    if (shouldIncludeField(fieldName, profile, selectedFields)) {
                        filteredFields[fieldName] = fieldValue;
                    }
                });
                track.fields = filteredFields;
            }

            return track;
        }

        function createXML(tracks) {
            let xml = `<scenario>
<definestring name='Interface' value='C2 HOST'/>
<definestring name='Air' value='12'/>
<definestring name='Land' value='48'/>
<definestring name='Surface' value='12'/>
<definestring name='SubSurface' value='12'/>
<definestring name='Space' value='12'/>
<definestring name='Reference_Point' value='12'/>
<definestring name='EW' value='12'/>
<definestring name='Unit' value='12'/>

`;

            // Add profile definitions
            const uniqueProfiles = [...new Set(tracks.map(t => t.track.profile))];
            uniqueProfiles.forEach(profile => {
                const updateInterval = profile === 'TOAD_J-Series_Land' ? '48' : '12';
                xml += `<profile name='${profile}'
   tracktype='${profile}'
   interface='C2 HOST'
   defaultTurnRate='180'
   defaultClimbRate='1000'
   defaultDescentRate='500'
   defaultAccelerationRate='2.6'
   defaultDecelerationRate='2'
   updateInterval='${updateInterval}'/>\n\n`;
            });

            xml += `<body>\n\n`;

            // Add tracks
            tracks.forEach(({ track, delay }) => {
                xml += `<createtrack name='${track.name}' profile='${track.profile}'>\n`;
                Object.entries(track.fields).forEach(([fieldName, fieldValue]) => {
                    if (fieldValue !== '' && fieldValue !== null && fieldValue !== undefined) {
                        xml += `    <field name='${fieldName}' value='${fieldValue}'/>\n`;
                    }
                });
                xml += `</createtrack>\n`;

                if (delay > 0) {
                    xml += `<wait seconds="${delay}"/>\n`;
                }
                xml += '\n';
            });

            xml += `<wait seconds='86400'/>\n</body>\n</scenario>`;

            return xml;
        }

        window.downloadXML = function() {
            const xml = document.getElementById('output').value;
            const numTracks = document.getElementById('num_tracks').value;
            const blob = new Blob([xml], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${numTracks} TacView Tracks.xml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.resetForm = function() {
            selectedProfiles = [];
            document.querySelectorAll('.profile-option input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                cb.parentElement.classList.remove('selected');
            });
            document.getElementById('num_tracks').value = '100';
            document.getElementById('start_lat').value = '33.0';
            document.getElementById('start_long').value = '-117.0';
            document.getElementById('delay').value = '1';
            document.getElementById('select_all_fields').checked = true;
            includeAllFields = true;
            document.getElementById('fields-container').style.display = 'none';
            document.getElementById('output-section').style.display = 'none';
        };

        // Utility functions
        function randomChoice(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
    </script>
</body>
</html>
